

variables:
  GIT_SUBMODULE_STRATEGY: normal

stages:
  - lint
  - build
  - test
  - docs
  - deploy

default:
  image: gitlab.vahanus.net:5050/vahanus/public/container-ubuntu-dlang-dev:latest
  #image: $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG
  before_script:
    - command -v docker && docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY || true
    - command -v docker && docker info || true
    - printenv | sort
    - ls -al
  after_script:
    - if test -e lastbuild.log ; then tail -n 60 lastbuild.log ; fi
    - ls -al

variables:
  #-- Workaround bug: https://gitlab.com/gitlab-org/gitlab-runner/issues/4501
  DOCKER_TLS_CERTDIR: ""

#----------------------------------------------------------------------

lint source:
  tags:
    - gitlabdocker
  stage: lint
  allow_failure: true
  script:
    - echo "linting $CI_COMMIT_REF_NAME / $CI_COMMIT_SHA ..."
    - dub lint

lint demo:
  tags:
    - gitlabdocker
  stage: lint
  allow_failure: true
  script:
    - echo "linting $CI_COMMIT_REF_NAME / $CI_COMMIT_SHA ..."
    - cd demo/xxhash3-demo && dub lint

#----------------------------------------------------------------------

build library:
  tags:
    - gitlabdocker
  stage: build
  script:
    - dub build
    - dub build -b release
    - dub build -b release --compiler=ldc2
  artifacts:
    name: "$CI_JOB_STAGE-$CI_COMMIT_REF_SLUG"
    paths:
      - libxxhash3.a

#----------------------------------------------------------------------

test program:
  tags:
    - gitlabdocker
  stage: test
  script:
    - dub test
    - dub test --compiler=ldc2
  artifacts:
    name: "$CI_JOB_STAGE-$CI_COMMIT_REF_SLUG"
    paths:
      - xxhash3-test-library

#----------------------------------------------------------------------

build docs:
  tags:
    - gitlabdocker
  stage: docs
  script:
    - dub build -b ddox
  artifacts:
    name: "$CI_JOB_STAGE-$CI_COMMIT_REF_SLUG"
    untracked: true
    paths:
      - docs/

#----------------------------------------------------------------------

deploy program:
  tags:
    - gitlabdocker
  stage: deploy
  script:
    - echo "Deploy!"
  when: manual
